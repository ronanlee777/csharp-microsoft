name: $(BuildDefinitionName)_$(date:yyMM).$(date:dd)$(rev:rrr)
jobs:
- job: Build
  pool:
    vmImage: 'VS2017-Win2016'
  timeoutInMinutes: 120
  strategy:
    maxParallel: 10
    matrix:
      Debug_x86:
        buildPlatform: 'x86'
        buildConfiguration: 'Debug'
      Release_x86:
        buildPlatform: 'x86'
        buildConfiguration: 'Release'
      Release_x64:
        buildPlatform: 'x64'
        buildConfiguration: 'Release'
      Release_Arm:
        buildPlatform: 'arm'
        buildConfiguration: 'Release'
      Release_Arm64:
        buildPlatform: 'arm64'
        buildConfiguration: 'Release'

  variables:
  - name: appxPackageDir
    value: $(build.artifactStagingDirectory)\$(buildConfiguration)\$(buildPlatform)\AppxPackages
  - name: buildOutputDir
    value: $(Build.SourcesDirectory)\BuildOutput
  - name: publishDir
    value: $(Build.ArtifactStagingDirectory)

  steps:
  - template: AzurePipelinesTemplates\MUX-BuildProject-Steps.yml
    parameters:
      solutionPath: MUXControls.sln
      nugetConfigPath: nuget.config
      appxPackageDir: $(appxPackageDir)
      buildOutputDir: $(buildOutputDir)
      publishDir: $(publishDir)

  - task: powershell@2
    displayName: 'Copy files to staging dir'
    inputs:
      targetType: filePath
      filePath: build\CopyFilesToStagingDir.ps1
      arguments: -BuildOutputDir '$(buildOutputDir)' -PublishDir '$(Build.ArtifactStagingDirectory)' -Platform '$(buildPlatform)' -Configuration '$(buildConfiguration)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish artifact: drop'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: 'drop'

# Create Nuget Package
- template: AzurePipelinesTemplates\MUX-CreateNugetPackage-Job.yml
  parameters:
    jobName: CreateNugetPackage
    dependsOn: Build
  
# Build solution that depends on nuget package
- template: AzurePipelinesTemplates\MUX-NugetReleaseTest-Job.yml
  parameters:
    dependsOn: CreateNugetPackage
    useNupkgFromArtifacts: true
    matrix: 
      Debug_x86:
        buildPlatform: 'x86'
        buildConfiguration: 'Debug'
      Debug_x64:
        buildPlatform: 'x64'
        buildConfiguration: 'Debug'
      Release_x64:
        buildPlatform: 'x64'
        buildConfiguration: 'Release'
      Release_arm:
        buildPlatform: 'arm'
        buildConfiguration: 'Release'
